#!/usr/bin/env python3
# coding=utf-8

'''taskcoach-category-efforts
'''

import sys
from os import environ
from os.path import pathsep
from datetime import datetime, timedelta

from pysyspol.taskcoach import (get_category_efforts, DEFAULT_DATETIME_FMT,
    plot_category_efforts)

TASKCOACH_FP = environ['SYSPOL_TASKCOACH_FP'].split(pathsep)
CATEGORIES = environ[\
    'SYSPOL_TASKCOACH_CATEGORY_EFFORT_VIEWER_DEFAULT_CATEGORIES'].split()
START = datetime.strptime(
        environ['SYSPOL_TASKCOACH_CATEGORY_EFFORT_VIEWER_DEFAULT_START'],
        DEFAULT_DATETIME_FMT)
try:
    END = datetime.strptime(
        environ['SYSPOL_TASKCOACH_CATEGORY_EFFORT_VIEWER_DEFAULT_END'],
        DEFAULT_DATETIME_FMT)
except ValueError:
    END = None

try:
    IMG_PLOT_FP = \
        environ['SYSPOL_TASKCOACH_CATEGORY_EFFORT_VIEWER_DEFAULT_IMG_PLOT_FP']\
        .split(pathsep)
except ValueError:
    IMG_PLOT_FP = ()

out = [(category, effort) for category, effort in
        get_category_efforts(CATEGORIES, START, END, paths=TASKCOACH_FP)]
total_effort = sum(record[1] for record in out)
out = [(category, effort, effort / total_effort) for category, effort in out]

for record in out:
    print('\t'.join(str(i) for i in record))

print(file=sys.stderr)
print('Start: {}, End: {}'.format(START, END), file=sys.stderr)
print('Total effort time: {}'.format(timedelta(seconds=total_effort)),
        file=sys.stderr)

plot_category_efforts(out, IMG_PLOT_FP)

# vim: ft=python
